<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>无标题文档</title>

<script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<style>
#gallery { float: left; width:45%; min-height: 4em; }
.gallery.custom-state-active { background: #eee; }
.gallery li { float: left; width: 96px; padding: 0.4em; margin: 0 0.4em 0.4em 0; text-align: center; }
.gallery li h5 { margin: 0 0 0.4em; cursor: move; }
.gallery li a { float: right; }
.gallery li a.ui-icon-zoomin { float: left; }
.gallery li img { width: 100%; cursor: move; }
#trash { float: right; width: 45%; min-height: 4em; padding: 15px; background:none }
#trash h4 { line-height: 16px; margin: 0 0 0.4em; }
#trash h4 .ui-icon { float: left; }

table td{ height:25px; width:50px; text-align:center; border:black 1px solid}
</style>
<script>
$(function() {
	var $gallery = $( "#gallery" ), $trash = $( "#trash" );
	$( "li", $gallery ).draggable({ cancel: "a.ui-icon",	revert: "invalid", containment: "document", helper: "clone", cursor: "move"});
	$( "li", $trash ).draggable({ cancel: "a.ui-icon",	revert: "invalid", containment: "document", helper: "clone", cursor: "move"});
	
	$trash.droppable({ accept: "#gallery > li", activeClass: "ui-state-highlight", drop: function( event, ui ) { deleteImage( ui.draggable ); } });
	$gallery.droppable({ accept: "#trash li", activeClass: "custom-state-active", drop: function( event, ui ) { recycleImage( ui.draggable ); } });
	
	function deleteImage($item) {
		$item.fadeOut(function() {
			var $list = $("ul", $trash ).length ? $("ul", $trash) : $( "<ul class='gallery ui-helper-reset'/>" ).appendTo($trash);
			$item.appendTo( $list ).fadeIn();
		});
	}
	
	function recycleImage( $item ) {
		$item.fadeOut(function() {
			$item.appendTo( $gallery ).fadeIn();
		});
	}

	$( ".doudou" ).each(function(){
		$(this).delegate("li","dblclick",function(){
		viewLargerImage( $(this).find('h5').html() );
		});
	});

	function viewLargerImage(text){
		var img = $("<p>"+text+"</p>");
		setTimeout(function() { img.dialog({ title: '阶段说明', width: 400, modal: true }); }, 1 ); 
	}
	
});
</script>
</head>
<body>
<div style="float:right">
	<h3>阶段选择</h3>
	
	<div class="ui-widget ui-helper-clearfix" style="border:#ccc 1px solid; padding:10px; margin-bottom:15px">
		<ul id="gallery" class="gallery ui-helper-reset ui-helper-clearfix doudou" style="border:#ccc 1px solid; padding:15px">
		<foreach name="node" item="vo">
			<li class="ui-widget-content ui-corner-tr" data-id="{$vo[id]}"><h5 class="ui-widget-header">{$vo[name]}</h5></li>
		</foreach>
		</ul>
		
	<div id="trash" class="ui-widget-content ui-state-default doudou"></div>
	
	</div>
	<div><button id="btn_sure">保存设置</button></div>
	<div id="div_form"></div>
</div>

<div style="float:left">
	<h3>进度表</h3>
	<select id="sel_nodeCho">
	<option>阶段</option>
	<foreach name="userStep" item="vo">
	<option value="{$vo[0][step]}">{$vo[0][node_name]}</option>
	</foreach>
	</select>
	<span id="sel_nodeSetHtml"></span>
	<table>
	<tr>
	<td>日期/阶段</td>
	<foreach name="userStep" item="vo">
	<td>{$vo[0][node_name]}</td>
	</foreach>
	</tr>
	<foreach name="timeLine" key="x" item="vo1">
	<tr>
	<td title="{$vo1[date]}">第{$vo1[day]}天</td>
	<foreach name="userStep" item="vo2">
		<td class="doudou" id="div_{$vo2[0][step]}_{$vo1[day]}"></td>
	</foreach>
	</tr>
	</foreach>
	</table>
</div>
<script>
</script>
</body>
<script>
var GROUP = '__GROUP__';
var node = eval({$nodeJson});
var userStep = eval({$userStepJson});
var timeLine = eval({$timeLineJson});
var Color = {'1':'#268DDC', '2':'#FF9129', '3':'#ccc', '4':'#55C9D3', '5':'#70BE01', '6':'#3879BF'};
$(function(){
	for(var i in timeLine){
		for(var j in timeLine[i]['step']){
			//alert(timeLine[i]['step'][j]);
				$("#div_"+timeLine[i]['step'][j]+"_"+timeLine[i]['day']).css({backgroundColor:Color[timeLine[i]['step'][j]]});
		}
	}
});

$("#btn_sure").bind('click', function(){
	$("#div_form").html("");
	var step = "";
	var form = [];
	var text = [];
	var arr = [];
	$("#trash").find('li').each(function(){
		var step_id = $(this).attr('data-id');
		step += ','+$(this).attr('data-id');
		for(var a in node){
			for(var b in userStep[node[a]['id']]){
				if(userStep[node[a]['id']][b]['status']!=1){
					var begin_time = userStep[node[a]['id']] === 'undefined' ? "" : userStep[node[a]['id']][b]['begin_time'];
					var end_time = userStep[node[a]['id']] === 'undefined' ? "" : userStep[node[a]['id']][b]['end_time'];
				}
			}
			if(node[a]['id'] == step_id){
				var k = timeToStr(begin_time);
				arr[k] = '<p>【'+node[a]["name"]+'】<input type="text" name="begin_date_'+step_id+'" id="datepicker_begin_date_'+step_id+'" size="30" value="'+begin_time+'">&nbsp;--&nbsp;<input type="text" name="end_date_'+step_id+'" id="datepicker_end_date_'+step_id+'" size="30" value="'+end_time+'"></p>';
				
				//text.push('<p>【'+node[a]["name"]+'】<input type="text" name="begin_date_'+step_id+'" id="datepicker_begin_date_'+step_id+'" size="30" value="'+begin_time+'">&nbsp;--&nbsp;<input type="text" name="end_date_'+step_id+'" id="datepicker_end_date_'+step_id+'" size="30" value="'+end_time+'"></p>')
			}
		}
	});
	
	arr.sort(sortNumber(1,2));
	
	for(var b in arr){
		
		text.push(arr[b]);
	}
	form.push('<form action="'+GROUP+'/Index/timeLine" method="post"><div>');
	form.push(text.join(""));
	form.push('<input type="hidden" value="'+step.substr(1)+'" id="hide_step" name="step"/>');
	form.push('</div><div><input type="submit" value="提交"/></div></form>');
	$("#div_form").append(form.join(""));
	$( "[id^=datepicker]" ).datepicker({ dateFormat: "yy-mm-dd" , showButtonPanel: true });
});
function sortNumber(a,b){
	return false;
}


function timeToStr(date){
	var date = date.replace(/-/g,'/')
	date = new Date(date);
	return date.getTime();
}

$("#sel_nodeCho").bind('change', function(){
	$.ajax({
		'type' : 'post',
		'url' : GROUP+'/Ajax/index',
		'data': 'ajax_act=sel_nodeCho&step='+$(this).val(),
		//'dataType': 'json',
		//'async' : false,
		'success': function(r){
			$("#sel_nodeSetHtml").html("");
			$("#sel_nodeSetHtml").append(r);
		}
	});
});
/*
$("#sel_nodeSet").bind('change', function(){
	if (!$("#sel_nodeCho").val() > 0)) return false;
	if (confim('确定？！')){
		$.ajax({
			'type' : 'post',
			'url' : GROUP+'/Ajax/index',
			'data': 'ajax_act=sel_nodeSet&step='+$("#sel_nodeCho").val()+''&do='+$(this).val(),
			//'dataType': 'json',
			//'async' : false,
			'success': function(r){
				window.location.reload();
			}
		});
	}
});
*/
</script>
</html>